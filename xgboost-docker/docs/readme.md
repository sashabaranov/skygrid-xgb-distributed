### Схема работы распределенного XGBoost
Здесь будут описана основная механика по запуску распределенного XGBoost в docker конетйнерах.

### Etcd сервер.
Необходимо пондять etcd сервер на одной из машин в локальной сети. Etcd нужен для синхронизации работы 
контейнеров между собой и для выбора лидера, на котором будем запускать алгоритм. Etcd представляет 
собой сервис для хранения пар ключ-значение, при этом ключи хранятся в дереве, похожем на дерево 
файловой системы. Для каждой задачи создаем отдельную директорию с именем 
(`http://$etcd_ip:$etcd_port/v2/keys/$task`), в которой и будем хранить все необхлдимые ключи. Чтение и
запись ключей происходит атомарно, поэтому они и используются для синхронизации.

## Скрипты синхринизации
[wait_etcd_barrier.sh](wait_etcd_barrier.sh) и [wait_etcd_key.py](wait_etcd_key.py) - 
вспомогательные скрипты, написанные для упрощения синхронизации. 

Первый создает барьер, 
принимая 5 аргументов командной строки: имя задачи, ip и порт etcd сервера, назване барьера и 
число контейнеров 
(пример: `./wait_etcd_barrier.sh $task $etcd_ip $etcd_port leader_election $clients_number` - барьер, 
используемый для leader election). Скрипт создает отдельную директорию 
(`http://$ip:$port/v2/keys/$task/$barrier`), в которую контейнеры пытаются одновременно записать 
наименьшее неотрицательное целое число, которое еще не было записано. Скрипт возвращает это число.

Второй ждет, пока не появится запрашиваемый ключ. Принимает 4 аргумента командной строки: 
имя задачи, ip и порт etcd сервера, назване ключа. Скрипт написан на питоне, так как на bash все не очень
хорошо с многопоточностью (Вообще, наверно, все стоило пеерписать на python, хоть бы это и превратилось
в последовательнось вызова функций subprocess. Кстати, есть [api](https://github.com/jplana/python-etcd)
для etcd на python.). Изначально у etcd нет запроса, ждущего появление ключа, 
а есть только запрос, ожидающий изменение. Поэтому, сначала запускается поток, ожидающий изменение ключа, 
затем в другом потоке читаем ключ, чтобы понять, не появился ли он уже.

## Послдовательность запросов контейнеров к etcd:

1. Leader election (через барьер leader_election)
2. Запись ip адреса в `http://$etcd_ip:$etcd_port/v2/keys/$task/ip/$order_number`
3. Барьер для ожидпния окончания записи ключей (ip_exchange)
4. Барьер для ожидания поднятия ssh (ssh)
5. Барьер после окончания обучения (training)
6. Барьер для ожидания завершения работы и удаления директории задачи (cleaner)

